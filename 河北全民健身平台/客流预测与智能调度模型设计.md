# å®¢æµé¢„æµ‹ä¸æ™ºèƒ½è°ƒåº¦æ¨¡å‹è®¾è®¡æ–¹æ¡ˆ

## ğŸ¯ æ¨¡å‹ç›®æ ‡

åŸºäºé¡¹ç›®ç°æœ‰çš„æ•°æ®é›†ã€NLPåˆ†æã€çŸ¥è¯†å›¾è°±ç­‰æ¨¡å—ï¼Œæ„å»ºä¸€ä¸ª**å¤šå› ç´ å®¢æµé¢„æµ‹æ¨¡å‹**ï¼Œå®ç°ï¼š

1. **å®¢æµé¢„æµ‹:** é¢„æµ‹æœªæ¥æ—¶æ®µçš„åœºé¦†å®¢æµé‡
2. **åŠ¨æ€è°ƒæ•´:** æ ¹æ®é¢„æµ‹ç»“æœè°ƒæ•´å¼€æ”¾æ—¶é—´
3. **æ™ºèƒ½åˆ†æµ:** ä¼˜åŒ–äººå‘˜åˆ†å¸ƒï¼Œé¿å…æ‹¥æŒ¤

---

## ğŸ“Š å¯åˆ©ç”¨çš„ç°æœ‰èµ„æº

### 1. æ•°æ®èµ„æº
- âœ… **158ä¸ªåœºé¦†æ•°æ®** (fitness_facilities_data.json)
  - åœºåœ°é¢ç§¯ã€åº§ä½æ•°ã€æ—¥å®¢æµé‡
  - å»ºæˆå¹´ä»½ã€è®¾æ–½ç±»å‹ã€è¿è¥å•ä½
  - åœ°ç†ä½ç½®ï¼ˆçœå¸‚åŒºï¼‰
  
- âœ… **çŸ¥è¯†å›¾è°±** (fps_knowledge_graph.json)
  - 254ä¸ªå®ä½“ï¼Œ634ä¸ªå…³ç³»
  - è®¾æ–½-åŒºåŸŸ-æ—¶é—´-æ”¿ç­–å…³ç³»ç½‘ç»œ
  - å¯æå–å…³ç³»ç‰¹å¾

- âœ… **NLPåˆ†æèƒ½åŠ›** (text_analyzer.py)
  - æ–‡æœ¬é‡åŒ–è½¬æ¢
  - è¯­ä¹‰è¯„åˆ†
  - å…³é”®è¯æå–

### 2. æ¨¡å‹èµ„æº
- âœ… **TransEåµŒå…¥æ¨¡å‹** - å¯ç”¨äºç‰¹å¾æå–
- âœ… **æ·±åº¦å­¦ä¹ æ¡†æ¶** - PyTorch
- âœ… **AHPè¯„ä»·æ¨¡å‹** - å¯ç”¨äºæƒé‡è®¡ç®—
- âœ… **æ¨èç³»ç»Ÿ** - ååŒè¿‡æ»¤ç®—æ³•

---

## ğŸ—ï¸ æ¨¡å‹æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®è¾“å…¥å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†å²å®¢æµ | æ—¶é—´ç‰¹å¾ | å¤©æ°” | äº‹ä»¶ | è®¾æ–½å±æ€§ | çŸ¥è¯†å›¾è°± â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç‰¹å¾å·¥ç¨‹å±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ—¶é—´ç‰¹å¾ï¼ˆå‘¨æœŸæ€§ã€è¶‹åŠ¿æ€§ï¼‰                         â”‚
â”‚ â€¢ åœºé¦†ç‰¹å¾ï¼ˆä»çŸ¥è¯†å›¾è°±æå–ï¼‰                         â”‚
â”‚ â€¢ å¤–éƒ¨å› ç´ ï¼ˆå¤©æ°”ã€èŠ‚å‡æ—¥ã€èµ›äº‹ï¼‰                     â”‚
â”‚ â€¢ çŸ¥è¯†å›¾è°±ç‰¹å¾ï¼ˆå…³ç³»åµŒå…¥ã€é‚»å±…ç‰¹å¾ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å®¢æµé¢„æµ‹æ¨¡å‹å±‚                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LSTMæ—¶åº | XGBoost | Prophet | çŸ¥è¯†å›¾è°±å¢å¼º          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            æ¨¡å‹èåˆå±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŠ æƒèåˆ | ç½®ä¿¡åŒºé—´ | å¼‚å¸¸æ£€æµ‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å†³ç­–ä¼˜åŒ–å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¼€æ”¾æ—¶é—´è°ƒæ•´ | äººå‘˜åˆ†æµ | èµ„æºé…ç½®                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            è¾“å‡ºä¸åé¦ˆå±‚                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é¢„æµ‹ç»“æœ | è°ƒåº¦æ–¹æ¡ˆ | å¯è§†åŒ– | æ•ˆæœè¯„ä¼°               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### ä¸€ã€ç‰¹å¾å·¥ç¨‹è®¾è®¡

#### 1.1 æ—¶é—´ç‰¹å¾æå–

**åŸºç¡€æ—¶é—´ç‰¹å¾:**
```python
{
    'hour': 14,              # å°æ—¶ (0-23)
    'day_of_week': 2,        # æ˜ŸæœŸå‡  (0-6)
    'day_of_month': 30,      # æ—¥æœŸ (1-31)
    'month': 10,             # æœˆä»½ (1-12)
    'quarter': 4,            # å­£åº¦ (1-4)
    'is_weekend': 0,         # æ˜¯å¦å‘¨æœ«
    'is_holiday': 0,         # æ˜¯å¦èŠ‚å‡æ—¥
}
```

**å‘¨æœŸæ€§ç‰¹å¾ï¼ˆæ­£å¼¦/ä½™å¼¦ç¼–ç ï¼‰:**
```python
{
    'hour_sin': sin(2Ï€ Ã— hour / 24),
    'hour_cos': cos(2Ï€ Ã— hour / 24),
    'day_sin': sin(2Ï€ Ã— day_of_week / 7),
    'day_cos': cos(2Ï€ Ã— day_of_week / 7),
    'month_sin': sin(2Ï€ Ã— month / 12),
    'month_cos': cos(2Ï€ Ã— month / 12),
}
```

**æ—¶é—´æ®µç‰¹å¾:**
```python
{
    'time_period': 'morning',  # morning/afternoon/evening/night
    'is_peak_hour': 1,         # æ˜¯å¦é«˜å³°æ—¶æ®µ (9-11, 18-20)
    'is_working_hour': 1,      # æ˜¯å¦å·¥ä½œæ—¶é—´ (9-18)
}
```

**æ»åç‰¹å¾:**
```python
{
    'visitors_lag_1h': 245,    # 1å°æ—¶å‰å®¢æµ
    'visitors_lag_24h': 230,   # 24å°æ—¶å‰å®¢æµ
    'visitors_lag_7d': 250,    # 7å¤©å‰åŒæ—¶æ®µå®¢æµ
    'visitors_avg_7d': 240,    # è¿‡å»7å¤©å¹³å‡å®¢æµ
}
```

#### 1.2 åœºé¦†ç‰¹å¾ï¼ˆä»çŸ¥è¯†å›¾è°±æå–ï¼‰

**åŸºç¡€å±æ€§ç‰¹å¾:**
```python
facility = kg.get_entity(facility_id)

features = {
    # è§„æ¨¡ç‰¹å¾
    'site_area': 26800,           # åœºåœ°é¢ç§¯
    'building_area': 3500,        # å»ºç­‘é¢ç§¯
    'seats': 448,                 # åº§ä½æ•°
    'capacity_ratio': 0.65,       # å®¹é‡åˆ©ç”¨ç‡
    
    # ç±»å‹ç‰¹å¾ï¼ˆOne-Hotç¼–ç ï¼‰
    'type_stadium': 1,
    'type_gymnasium': 0,
    'type_fitness': 0,
    'type_swimming': 0,
    
    # æ—¶é—´ç‰¹å¾
    'build_year': 1991,
    'facility_age': 33,           # åœºé¦†å¹´é¾„
    
    # ä½ç½®ç‰¹å¾
    'city_code': 1,               # åŸå¸‚ç¼–ç 
    'is_provincial_capital': 0,   # æ˜¯å¦çœä¼š
}
```

**çŸ¥è¯†å›¾è°±å…³ç³»ç‰¹å¾:**
```python
# ä»çŸ¥è¯†å›¾è°±æå–
kg_features = {
    # è¿åŠ¨é¡¹ç›®ç‰¹å¾
    'sport_count': 5,                    # æä¾›è¿åŠ¨é¡¹ç›®æ•°
    'has_basketball': 1,
    'has_swimming': 0,
    'has_fitness': 1,
    
    # æ”¿ç­–ç‰¹å¾
    'has_subsidy': 1,                    # æ˜¯å¦æœ‰è¡¥åŠ©
    'policy_count': 2,                   # å—ç›Šæ”¿ç­–æ•°
    
    # é‚»å±…ç‰¹å¾
    'nearby_facility_count': 33,         # åŒåŸè®¾æ–½æ•°
    'nearby_avg_visitors': 280,          # åŒåŸå¹³å‡å®¢æµ
    'nearby_total_area': 299300,         # åŒåŸæ€»é¢ç§¯
    
    # åŒºåŸŸç‰¹å¾
    'city_facility_density': 0.034,      # åŸå¸‚è®¾æ–½å¯†åº¦
    'city_per_capita_area': 0.30,        # äººå‡åœºåœ°é¢ç§¯
}
```

#### 1.3 å¤–éƒ¨å› ç´ ç‰¹å¾

**å¤©æ°”ç‰¹å¾:**
```python
{
    'weather_code': 0,        # å¤©æ°”ç¼–ç  (0æ™´ 1é˜´ 2é›¨ 3é›ª)
    'temperature': 22,        # æ¸©åº¦
    'temperature_comfort': 1, # èˆ’é€‚åº¦ (15-25â„ƒä¸º1)
    'is_rainy': 0,           # æ˜¯å¦ä¸‹é›¨
    'aqi': 85,               # ç©ºæ°”è´¨é‡æŒ‡æ•°
    'aqi_level': 2,          # AQIç­‰çº§ (1ä¼˜ 2è‰¯ 3è½»åº¦æ±¡æŸ“...)
}
```

**äº‹ä»¶ç‰¹å¾:**
```python
{
    'has_event': 0,          # æ˜¯å¦æœ‰èµ›äº‹æ´»åŠ¨
    'event_type': None,      # æ´»åŠ¨ç±»å‹
    'is_school_holiday': 0,  # æ˜¯å¦å­¦æ ¡å‡æœŸ
    'days_to_holiday': 5,    # è·ç¦»ä¸‹ä¸ªå‡æœŸå¤©æ•°
}
```

---

### äºŒã€é¢„æµ‹æ¨¡å‹è®¾è®¡

#### 2.1 LSTMæ—¶åºé¢„æµ‹æ¨¡å‹

**æ¨¡å‹ç»“æ„:**
```python
import torch
import torch.nn as nn

class LSTMTrafficPredictor(nn.Module):
    def __init__(self, input_size=50, hidden_size=128, num_layers=2):
        super().__init__()
        
        # LSTMå±‚
        self.lstm = nn.LSTM(
            input_size=input_size,
            hidden_size=hidden_size,
            num_layers=num_layers,
            batch_first=True,
            dropout=0.2
        )
        
        # æ³¨æ„åŠ›æœºåˆ¶
        self.attention = nn.Linear(hidden_size, 1)
        
        # å…¨è¿æ¥å±‚
        self.fc = nn.Sequential(
            nn.Linear(hidden_size, 64),
            nn.ReLU(),
            nn.Dropout(0.2),
            nn.Linear(64, 32),
            nn.ReLU(),
            nn.Linear(32, 1)
        )
    
    def forward(self, x):
        # x: (batch, seq_len, input_size)
        lstm_out, _ = self.lstm(x)
        
        # æ³¨æ„åŠ›æƒé‡
        attention_weights = torch.softmax(
            self.attention(lstm_out), dim=1
        )
        
        # åŠ æƒæ±‚å’Œ
        context = torch.sum(attention_weights * lstm_out, dim=1)
        
        # é¢„æµ‹
        output = self.fc(context)
        return output
```

**è®­ç»ƒç­–ç•¥:**
- åºåˆ—é•¿åº¦: 24å°æ—¶ï¼ˆé¢„æµ‹ä¸‹1å°æ—¶ï¼‰
- æ‰¹æ¬¡å¤§å°: 64
- å­¦ä¹ ç‡: 0.001
- ä¼˜åŒ–å™¨: Adam
- æŸå¤±å‡½æ•°: MSE + MAE

**é€‚ç”¨åœºæ™¯:**
- æ•æ‰æ—¶é—´åºåˆ—çš„é•¿æœŸä¾èµ–
- å¤„ç†å‘¨æœŸæ€§æ¨¡å¼
- é€‚åˆè¿ç»­é¢„æµ‹

#### 2.2 XGBoostå›å½’æ¨¡å‹

**æ¨¡å‹é…ç½®:**
```python
import xgboost as xgb

model = xgb.XGBRegressor(
    n_estimators=1000,
    learning_rate=0.05,
    max_depth=6,
    min_child_weight=3,
    subsample=0.8,
    colsample_bytree=0.8,
    gamma=0.1,
    reg_alpha=0.1,
    reg_lambda=1.0,
    objective='reg:squarederror'
)
```

**ç‰¹å¾é‡è¦æ€§åˆ†æ:**
```python
# è·å–ç‰¹å¾é‡è¦æ€§
importance = model.feature_importances_

# å¯è§†åŒ–
top_features = [
    'visitors_lag_24h',      # é‡è¦æ€§: 0.25
    'hour_of_day',           # é‡è¦æ€§: 0.18
    'day_of_week',           # é‡è¦æ€§: 0.15
    'temperature',           # é‡è¦æ€§: 0.12
    'nearby_avg_visitors',   # é‡è¦æ€§: 0.10
    ...
]
```

**é€‚ç”¨åœºæ™¯:**
- å¤„ç†éçº¿æ€§å…³ç³»
- ç‰¹å¾äº¤äº’å»ºæ¨¡
- é²æ£’æ€§å¼º

#### 2.3 Prophetè¶‹åŠ¿é¢„æµ‹

**æ¨¡å‹é…ç½®:**
```python
from prophet import Prophet

model = Prophet(
    yearly_seasonality=True,
    weekly_seasonality=True,
    daily_seasonality=True,
    seasonality_mode='multiplicative',
    changepoint_prior_scale=0.05
)

# æ·»åŠ è‡ªå®šä¹‰å­£èŠ‚æ€§
model.add_seasonality(
    name='hourly',
    period=24,
    fourier_order=8
)

# æ·»åŠ èŠ‚å‡æ—¥æ•ˆåº”
model.add_country_holidays(country_name='CN')
```

**é€‚ç”¨åœºæ™¯:**
- é•¿æœŸè¶‹åŠ¿é¢„æµ‹
- è‡ªåŠ¨å¤„ç†å­£èŠ‚æ€§
- èŠ‚å‡æ—¥æ•ˆåº”å»ºæ¨¡

#### 2.4 çŸ¥è¯†å›¾è°±å¢å¼ºæ¨¡å‹

**æ ¸å¿ƒæ€æƒ³:** åˆ©ç”¨çŸ¥è¯†å›¾è°±ä¸­çš„å…³ç³»ä¿¡æ¯å¢å¼ºé¢„æµ‹

```python
class KGEnhancedPredictor:
    def __init__(self, base_model, kg_query):
        self.base_model = base_model
        self.kg = kg_query
    
    def predict(self, facility_id, timestamp, features):
        # 1. åŸºç¡€é¢„æµ‹
        base_pred = self.base_model.predict(features)
        
        # 2. ä»çŸ¥è¯†å›¾è°±æå–é‚»å±…ä¿¡æ¯
        city = self.kg.get_facility_city(facility_id)
        neighbors = self.kg.query_city_facilities(city)
        
        # 3. è®¡ç®—é‚»å±…å½±å“
        neighbor_preds = []
        for neighbor in neighbors:
            if neighbor['id'] != facility_id:
                # è·å–é‚»å±…çš„é¢„æµ‹å€¼
                neighbor_pred = self.get_neighbor_prediction(
                    neighbor['id'], timestamp
                )
                # æ ¹æ®è·ç¦»å’Œç›¸ä¼¼åº¦åŠ æƒ
                weight = self.calculate_similarity(
                    facility_id, neighbor['id']
                )
                neighbor_preds.append(neighbor_pred * weight)
        
        # 4. èåˆé¢„æµ‹
        if neighbor_preds:
            neighbor_avg = np.mean(neighbor_preds)
            # è‡ªé€‚åº”æƒé‡
            alpha = 0.7  # åŸºç¡€æ¨¡å‹æƒé‡
            beta = 0.3   # é‚»å±…å½±å“æƒé‡
            final_pred = alpha * base_pred + beta * neighbor_avg
        else:
            final_pred = base_pred
        
        return final_pred
    
    def calculate_similarity(self, fac1, fac2):
        """è®¡ç®—è®¾æ–½ç›¸ä¼¼åº¦"""
        # åŸºäºçŸ¥è¯†å›¾è°±çš„ç›¸ä¼¼åº¦
        # 1. å…±åŒè¿åŠ¨é¡¹ç›®
        sports1 = set(self.kg.query_facility_sports(fac1))
        sports2 = set(self.kg.query_facility_sports(fac2))
        sport_sim = len(sports1 & sports2) / len(sports1 | sports2)
        
        # 2. è®¾æ–½ç±»å‹ç›¸ä¼¼åº¦
        type1 = self.kg.get_entity(fac1)['type']
        type2 = self.kg.get_entity(fac2)['type']
        type_sim = 1.0 if type1 == type2 else 0.5
        
        # 3. è§„æ¨¡ç›¸ä¼¼åº¦
        area1 = self.kg.get_entity(fac1)['site_area']
        area2 = self.kg.get_entity(fac2)['site_area']
        area_sim = 1 - abs(area1 - area2) / max(area1, area2)
        
        # åŠ æƒå¹³å‡
        similarity = 0.4 * sport_sim + 0.3 * type_sim + 0.3 * area_sim
        return similarity
```

---

### ä¸‰ã€æ¨¡å‹èåˆç­–ç•¥

#### 3.1 åŠ æƒèåˆ

```python
class EnsemblePredictor:
    def __init__(self):
        self.models = {
            'lstm': LSTMTrafficPredictor(),
            'xgboost': XGBoostTrafficPredictor(),
            'prophet': ProphetTrafficPredictor(),
            'kg_enhanced': KGEnhancedPredictor()
        }
        
        # åŠ¨æ€æƒé‡ï¼ˆæ ¹æ®éªŒè¯é›†è¡¨ç°ï¼‰
        self.weights = {
            'lstm': 0.35,
            'xgboost': 0.30,
            'prophet': 0.20,
            'kg_enhanced': 0.15
        }
    
    def predict(self, facility_id, timestamp, features):
        predictions = {}
        
        # å„æ¨¡å‹é¢„æµ‹
        for name, model in self.models.items():
            predictions[name] = model.predict(
                facility_id, timestamp, features
            )
        
        # åŠ æƒèåˆ
        final_pred = sum(
            predictions[name] * self.weights[name]
            for name in predictions
        )
        
        # è®¡ç®—ç½®ä¿¡åŒºé—´
        std = np.std(list(predictions.values()))
        confidence_interval = (
            max(0, final_pred - 1.96 * std),
            final_pred + 1.96 * std
        )
        
        return {
            'prediction': int(final_pred),
            'confidence_interval': confidence_interval,
            'individual_predictions': predictions
        }
```

#### 3.2 å¼‚å¸¸æ£€æµ‹

```python
class AnomalyDetector:
    def detect(self, prediction, historical_data):
        """æ£€æµ‹é¢„æµ‹å¼‚å¸¸"""
        # 1. ç»Ÿè®¡å¼‚å¸¸
        mean = np.mean(historical_data)
        std = np.std(historical_data)
        z_score = (prediction - mean) / std
        
        if abs(z_score) > 3:
            # å¼‚å¸¸ä¿®æ­£
            corrected = mean + np.sign(z_score) * 2 * std
            return True, corrected
        
        # 2. å®¹é‡çº¦æŸ
        max_capacity = self.get_max_capacity(facility_id)
        if prediction > max_capacity:
            return True, max_capacity
        
        return False, prediction
```

---

### å››ã€æ™ºèƒ½è°ƒåº¦å†³ç­–

#### 4.1 å¼€æ”¾æ—¶é—´åŠ¨æ€è°ƒæ•´

**å†³ç­–è§„åˆ™:**
```python
class OpeningTimeOptimizer:
    def optimize(self, facility_id, predictions):
        """ä¼˜åŒ–å¼€æ”¾æ—¶é—´"""
        schedule = []
        
        for hour in range(24):
            pred_visitors = predictions[hour]
            
            # å†³ç­–è§„åˆ™
            if pred_visitors < 50:
                status = 'closed'
                staff = 0
            elif pred_visitors < 150:
                status = 'limited_open'  # éƒ¨åˆ†å¼€æ”¾
                staff = 2
            elif pred_visitors < 300:
                status = 'normal_open'
                staff = 4
            else:
                status = 'full_open'
                staff = 6
            
            schedule.append({
                'hour': hour,
                'predicted_visitors': pred_visitors,
                'status': status,
                'staff_count': staff
            })
        
        return schedule
```

**è°ƒæ•´ç­–ç•¥:**
```python
# ç¤ºä¾‹è¾“å‡º
{
    '06:00-09:00': {
        'status': 'limited_open',
        'areas': ['å®¤å¤–åœºåœ°'],
        'staff': 2
    },
    '09:00-12:00': {
        'status': 'full_open',
        'areas': ['å…¨éƒ¨åœºåœ°'],
        'staff': 6
    },
    '12:00-14:00': {
        'status': 'normal_open',
        'areas': ['å®¤å†…åœºé¦†'],
        'staff': 4
    },
    ...
}
```

#### 4.2 äººå‘˜åˆ†æµç­–ç•¥

**åˆ†æµç®—æ³•:**
```python
class TrafficDistributor:
    def distribute(self, city_facilities, predictions):
        """æ™ºèƒ½åˆ†æµ"""
        recommendations = []
        
        for facility in city_facilities:
            fac_id = facility['id']
            pred = predictions[fac_id]
            capacity = facility['capacity']
            
            # è®¡ç®—è´Ÿè½½ç‡
            load_rate = pred / capacity
            
            # åˆ†æµå»ºè®®
            if load_rate > 0.9:
                # æ¨èåˆ°é‚»è¿‘è®¾æ–½
                alternatives = self.find_alternatives(
                    fac_id, city_facilities
                )
                recommendations.append({
                    'facility_id': fac_id,
                    'status': 'crowded',
                    'load_rate': load_rate,
                    'alternatives': alternatives
                })
            elif load_rate < 0.3:
                recommendations.append({
                    'facility_id': fac_id,
                    'status': 'available',
                    'load_rate': load_rate
                })
        
        return recommendations
    
    def find_alternatives(self, facility_id, all_facilities):
        """æŸ¥æ‰¾æ›¿ä»£åœºé¦†"""
        # ä»çŸ¥è¯†å›¾è°±è·å–ç›¸ä¼¼è®¾æ–½
        target = self.kg.get_entity(facility_id)
        target_sports = self.kg.query_facility_sports(facility_id)
        
        alternatives = []
        for fac in all_facilities:
            if fac['id'] == facility_id:
                continue
            
            # æ£€æŸ¥è¿åŠ¨é¡¹ç›®åŒ¹é…
            fac_sports = self.kg.query_facility_sports(fac['id'])
            if set(target_sports) & set(fac_sports):
                # è®¡ç®—è·ç¦»ï¼ˆç®€åŒ–ä¸ºåŒåŸï¼‰
                if fac['city'] == target['city']:
                    alternatives.append({
                        'facility_id': fac['id'],
                        'name': fac['name'],
                        'distance': 'nearby',
                        'predicted_load': fac['predicted_load']
                    })
        
        # æŒ‰è´Ÿè½½ç‡æ’åº
        alternatives.sort(key=lambda x: x['predicted_load'])
        return alternatives[:3]
```

---

### äº”ã€å®æ–½æ–¹æ¡ˆ

#### 5.1 æ•°æ®å‡†å¤‡

**æ­¥éª¤1: è¡¥å……æ•°æ®**
```python
# éœ€è¦è¡¥å……çš„æ•°æ®
required_data = {
    'hourly_traffic': 'å°æ—¶çº§å®¢æµæ•°æ®',
    'weather': 'å¤©æ°”æ•°æ®ï¼ˆå¯è°ƒç”¨APIï¼‰',
    'events': 'èµ›äº‹æ´»åŠ¨æ•°æ®',
    'holidays': 'èŠ‚å‡æ—¥æ•°æ®'
}
```

**æ­¥éª¤2: æ•°æ®ç”Ÿæˆï¼ˆæ¨¡æ‹Ÿï¼‰**
```python
# åŸºäºç°æœ‰æ—¥å®¢æµæ•°æ®ç”Ÿæˆå°æ—¶æ•°æ®
def generate_hourly_data(daily_visitors):
    """ç”Ÿæˆå°æ—¶åˆ†å¸ƒ"""
    # å…¸å‹åˆ†å¸ƒæ¨¡å¼
    hourly_pattern = {
        6: 0.02, 7: 0.04, 8: 0.06, 9: 0.08,
        10: 0.07, 11: 0.06, 12: 0.05, 13: 0.04,
        14: 0.05, 15: 0.06, 16: 0.08, 17: 0.10,
        18: 0.12, 19: 0.10, 20: 0.05, 21: 0.02
    }
    
    hourly_data = {}
    for hour, ratio in hourly_pattern.items():
        hourly_data[hour] = int(daily_visitors * ratio)
    
    return hourly_data
```

#### 5.2 æ¨¡å‹è®­ç»ƒæµç¨‹

```python
# 1. åŠ è½½æ•°æ®
facilities_data = load_json('fitness_facilities_data.json')
kg_data = load_json('fps_knowledge_graph.json')

# 2. ç‰¹å¾å·¥ç¨‹
feature_extractor = FeatureExtractor(kg_data)
X, y = feature_extractor.prepare_training_data(facilities_data)

# 3. è®­ç»ƒå„æ¨¡å‹
models = {
    'lstm': train_lstm_model(X, y),
    'xgboost': train_xgboost_model(X, y),
    'prophet': train_prophet_model(X, y),
    'kg_enhanced': train_kg_model(X, y, kg_data)
}

# 4. æ¨¡å‹èåˆ
ensemble = EnsemblePredictor(models)

# 5. è¯„ä¼°
metrics = evaluate_model(ensemble, X_test, y_test)
```

#### 5.3 éƒ¨ç½²æ–¹æ¡ˆ

**APIæ¥å£è®¾è®¡:**
```python
# FastAPIç«¯ç‚¹
@app.post("/api/v1/traffic/predict")
async def predict_traffic(request: PredictRequest):
    """é¢„æµ‹å®¢æµ"""
    prediction = ensemble.predict(
        facility_id=request.facility_id,
        timestamp=request.timestamp,
        features=request.features
    )
    return prediction

@app.post("/api/v1/schedule/optimize")
async def optimize_schedule(facility_id: str, date: str):
    """ä¼˜åŒ–å¼€æ”¾æ—¶é—´"""
    # é¢„æµ‹24å°æ—¶å®¢æµ
    predictions = []
    for hour in range(24):
        pred = predict_traffic(facility_id, f"{date} {hour}:00")
        predictions.append(pred)
    
    # ç”Ÿæˆè°ƒåº¦æ–¹æ¡ˆ
    schedule = optimizer.optimize(facility_id, predictions)
    return schedule

@app.post("/api/v1/traffic/distribute")
async def distribute_traffic(city: str, timestamp: str):
    """æ™ºèƒ½åˆ†æµ"""
    facilities = kg.query_city_facilities(city)
    predictions = predict_all_facilities(facilities, timestamp)
    recommendations = distributor.distribute(facilities, predictions)
    return recommendations
```

---

### å…­ã€è¯„ä¼°æŒ‡æ ‡

#### 6.1 é¢„æµ‹å‡†ç¡®æ€§
- **MAE** (å¹³å‡ç»å¯¹è¯¯å·®): < 20äºº
- **RMSE** (å‡æ–¹æ ¹è¯¯å·®): < 30äºº
- **MAPE** (å¹³å‡ç»å¯¹ç™¾åˆ†æ¯”è¯¯å·®): < 15%
- **RÂ²** (å†³å®šç³»æ•°): > 0.85

#### 6.2 ä¸šåŠ¡æŒ‡æ ‡
- **åœºé¦†åˆ©ç”¨ç‡æå‡**: > 15%
- **ç”¨æˆ·ç­‰å¾…æ—¶é—´å‡å°‘**: > 20%
- **è¿è¥æˆæœ¬é™ä½**: > 10%
- **ç”¨æˆ·æ»¡æ„åº¦æå‡**: > 25%

---

### ä¸ƒã€å¯è§†åŒ–å±•ç¤º

#### 7.1 é¢„æµ‹ç»“æœå¯è§†åŒ–
- æ—¶é—´åºåˆ—å›¾ï¼ˆå®é™… vs é¢„æµ‹ï¼‰
- ç½®ä¿¡åŒºé—´å±•ç¤º
- å„æ¨¡å‹å¯¹æ¯”
- ç‰¹å¾é‡è¦æ€§å›¾

#### 7.2 è°ƒåº¦æ–¹æ¡ˆå¯è§†åŒ–
- 24å°æ—¶å¼€æ”¾æ—¶é—´è¡¨
- äººå‘˜é…ç½®ç”˜ç‰¹å›¾
- è´Ÿè½½ç‡çƒ­åŠ›å›¾
- åˆ†æµè·¯çº¿å›¾

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿
1. **å¤šæ¨¡å‹èåˆ**: LSTM+XGBoost+Prophet+çŸ¥è¯†å›¾è°±
2. **çŸ¥è¯†å›¾è°±å¢å¼º**: åˆ©ç”¨è®¾æ–½å…³ç³»ç½‘ç»œæå‡é¢„æµ‹
3. **å®Œæ•´å†³ç­–é“¾**: é¢„æµ‹â†’è°ƒåº¦â†’åˆ†æµ
4. **å¯è§£é‡Šæ€§å¼º**: ç‰¹å¾é‡è¦æ€§+æ¨¡å‹å¯¹æ¯”

### åˆ›æ–°ç‚¹
1. é¦–æ¬¡å°†çŸ¥è¯†å›¾è°±åº”ç”¨äºå®¢æµé¢„æµ‹
2. åŸºäºLKDFæ¡†æ¶çš„å¤šç»´åº¦ç‰¹å¾å»ºæ¨¡
3. åŠ¨æ€æƒé‡çš„æ¨¡å‹èåˆç­–ç•¥
4. æ™ºèƒ½åˆ†æµçš„å›¾ç®—æ³•åº”ç”¨

### å®æ–½å»ºè®®
1. **çŸ­æœŸ**: åŸºäºç°æœ‰æ•°æ®è®­ç»ƒåŸºç¡€æ¨¡å‹
2. **ä¸­æœŸ**: è¡¥å……å®æ—¶æ•°æ®ï¼Œä¼˜åŒ–æ¨¡å‹
3. **é•¿æœŸ**: æ¥å…¥IoTè®¾å¤‡ï¼Œå®ç°é—­ç¯

---

**æ–‡æ¡£ç‰ˆæœ¬:** 1.0  
**æ›´æ–°æ—¶é—´:** 2025-10-30  
**è®¾è®¡è€…:** AI Assistant
